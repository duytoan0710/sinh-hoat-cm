
<div class="animate-fade-in">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold text-gray-900">Phiếu dự giờ đánh giá tiết dạy (Thông tư 27)</h2>
    <div class="flex items-center gap-4">
      <button type="button" (click)="viewClicked.emit()" class="rounded-md bg-white px-3.5 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
        Xem biên bản
      </button>
      <button type="button" (click)="downloadClicked.emit()" class="rounded-md bg-white px-3.5 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        Tải file PDF
      </button>
    </div>
  </div>
  <p class="text-sm text-gray-600 text-justify mb-6">
    Vai trò chính: Đây là phiếu dùng để quan sát và đánh giá tiết dạy của giáo viên đang làm việc (không phải sinh viên). Người dự giờ (có thể là lãnh đạo trường, tổ chuyên môn, hoặc đồng nghiệp) ghi chép tiến trình dạy học, đánh giá các tiêu chí về kế hoạch bài giảng, hoạt động của giáo viên (GV), hoạt động của học sinh (HS), và xếp loại tổng thể (Giỏi, Khá, Trung bình, Không đạt) với tổng điểm 20. Phiếu có phần chi tiết về tiến trình (cột hoạt động GV-HS và nhận xét), đánh giá ưu khuyết điểm, và yêu cầu ký xác nhận từ nhiều bên (giáo viên dạy, hiệu trưởng/tổ chuyên môn, người dự). Nó mang tính hành chính cao hơn, có thể dùng cho đánh giá hiệu suất công việc hoặc xếp loại thi đua.
  </p>
  <form [formGroup]="evaluationForm" (ngSubmit)="onSubmit()" class="space-y-4">

    <!-- Section: Header Info -->
    <div class="rounded-lg bg-white shadow-sm overflow-hidden border">
      <button type="button" (click)="toggleSection('header')" class="w-full flex justify-between items-center p-3 text-left bg-gradient-to-r from-teal-50 via-sky-50 to-indigo-50 hover:from-teal-100 transition-colors focus:outline-none">
        <h3 class="text-sm font-bold uppercase tracking-wider text-teal-800">Thông tin chung</h3>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform transition-transform duration-300 text-teal-600" [class.rotate-180]="!sections().header" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
      </button>
      @if (sections().header) {
        <div class="p-6 border-t animate-fade-in-down grid grid-cols-1 sm:grid-cols-4 gap-x-6 gap-y-4">
          <div class="sm:col-span-2">
            <label for="teacher-eval" class="block text-sm font-medium leading-6 text-gray-900">Họ và tên người dạy</label>
            <div class="mt-1">
              <select id="teacher-eval" formControlName="teacher" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"><option disabled value="">Chọn</option>@for(t of teachers(); track t){<option [value]="t">{{t}}</option>}</select>
            </div>
          </div>
          <div><label for="subject-eval" class="block text-sm font-medium leading-6 text-gray-900">Môn</label><div class="mt-1"><input type="text" id="subject-eval" formControlName="subject" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></div></div>
          <div><label for="class-eval" class="block text-sm font-medium leading-6 text-gray-900">Lớp</label><div class="mt-1"><input type="text" id="class-eval" formControlName="class" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></div></div>
          <div><label for="period-eval" class="block text-sm font-medium leading-6 text-gray-900">Tiết</label><div class="mt-1"><input type="text" id="period-eval" formControlName="period" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></div></div>
          <div><label for="ppct-eval" class="block text-sm font-medium leading-6 text-gray-900">Tiết PPCT</label><div class="mt-1"><input type="text" id="ppct-eval" formControlName="ppct" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></div></div>
          <div>
            <label for="date-eval" class="block text-sm font-medium leading-6 text-gray-900">Ngày</label>
            <div class="relative mt-1">
              <input type="date" id="date-eval" formControlName="date" class="block w-full rounded-md border-0 py-1.5 pl-3 pr-10 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18" /></svg>
              </div>
            </div>
          </div>
          <div><label for="session-eval" class="block text-sm font-medium leading-6 text-gray-900">Buổi</label><div class="mt-1"><input type="text" id="session-eval" formControlName="session" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></div></div>
          <div class="sm:col-span-4"><label for="lesson-eval" class="block text-sm font-medium leading-6 text-gray-900">Bài dạy</label><div class="mt-1"><input type="text" id="lesson-eval" formControlName="lesson" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></div></div>
          <div class="sm:col-span-2"><label for="observerName-eval" class="block text-sm font-medium leading-6 text-gray-900">Họ và tên người dự</label><div class="mt-1"><input type="text" id="observerName-eval" formControlName="observerName" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></div></div>
          <div><label for="observerPosition-eval" class="block text-sm font-medium leading-6 text-gray-900">Chức vụ</label><div class="mt-1"><input type="text" id="observerPosition-eval" formControlName="observerPosition" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></div></div>
          <div><label for="observerDepartment-eval" class="block text-sm font-medium leading-6 text-gray-900">Đơn vị công tác</label><div class="mt-1"><input type="text" id="observerDepartment-eval" formControlName="observerDepartment" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></div></div>
        </div>
      }
    </div>

     <!-- Section: Process -->
    <div class="rounded-lg bg-white shadow-sm overflow-hidden border">
       <button type="button" (click)="toggleSection('process')" class="w-full flex justify-between items-center p-3 text-left bg-gradient-to-r from-teal-50 via-sky-50 to-indigo-50 hover:from-teal-100 transition-colors focus:outline-none">
        <h3 class="text-sm font-bold uppercase tracking-wider text-teal-800">I. TIẾN TRÌNH HOẠT ĐỘNG DẠY VÀ HỌC</h3>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform transition-transform duration-300 text-teal-600" [class.rotate-180]="!sections().process" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
      </button>
      @if (sections().process) {
        <div class="p-6 border-t animate-fade-in-down" formArrayName="teachingProcess">
          <div class="overflow-x-auto -mx-6 -my-6">
            <table class="min-w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hoạt động của GV</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hoạt động của HS</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nhận xét, ghi chú</th>
                  <th class="w-16 px-6 py-3"></th>
                </tr>
              </thead>
              <tbody class="bg-white">
                @for(row of teachingProcess.controls; track $index) {
                  <tr [formGroupName]="$index" class="border-t">
                    <td class="p-2"><textarea formControlName="teacherActivity" rows="3" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></textarea></td>
                    <td class="p-2"><textarea formControlName="studentActivity" rows="3" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></textarea></td>
                    <td class="p-2"><textarea formControlName="observerNotes" rows="3" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></textarea></td>
                    <td class="text-center p-2"><button type="button" (click)="removeProcessRow($index)" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100">&times;</button></td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
          <div class="mt-4"><button type="button" (click)="addProcessRow()" class="text-sm font-medium text-indigo-600 hover:text-indigo-800">+ Thêm hàng</button></div>
        </div>
      }
    </div>

    <!-- Section: Rating -->
    <div class="rounded-lg bg-white shadow-sm overflow-hidden border">
       <button type="button" (click)="toggleSection('rating')" class="w-full flex justify-between items-center p-3 text-left bg-gradient-to-r from-teal-50 via-sky-50 to-indigo-50 hover:from-teal-100 transition-colors focus:outline-none">
        <h3 class="text-sm font-bold uppercase tracking-wider text-teal-800">II. XẾP LOẠI TIẾT DẠY</h3>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform transition-transform duration-300 text-teal-600" [class.rotate-180]="!sections().rating" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
      </button>
       @if (sections().rating) {
        <div class="p-6 border-t animate-fade-in-down">
          <div class="overflow-x-auto -m-6">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left font-medium text-gray-600 uppercase tracking-wider w-2/5">Nội dung</th>
                  <th class="px-4 py-3 text-left font-medium text-gray-600 uppercase tracking-wider w-2/5">Tiêu chí</th>
                  <th class="px-4 py-3 text-left font-medium text-gray-600 uppercase tracking-wider w-1/5">Điểm</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                @for(item of ratingCriteria; track item.name) {
                  <tr>
                    <td class="px-4 py-3 align-top font-medium text-gray-700">{{ item.content }}</td>
                    <td class="px-4 py-3 align-top text-gray-600">{{ item.criteria }}</td>
                    <td class="px-4 py-3 align-top">
                      <input type="number" [formControlName]="item.name" class="block w-24 rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" [max]="item.name.includes('score1') || item.name.includes('score2') || item.name.includes('score3') || item.name.includes('score4') ? 1 : 2" min="0" step="0.25">
                    </td>
                  </tr>
                }
                <tr class="bg-gray-50">
                    <td colspan="2" class="px-4 py-3 text-right font-bold text-gray-800">Tổng số điểm:</td>
                    <td class="px-4 py-3 font-bold text-xl text-indigo-700">{{ totalScore() }} / 20</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
            <p><strong>a) Loại Giỏi:</strong> 17,50 – 20,0 điểm; các tiêu chí 5, 7, 11, 12 phải đạt 2,0 điểm; các tiêu chí còn lại phải đạt từ mức 2 tương ứng trở lên.</p>
            <p><strong>b) Loại Khá:</strong> 14,50 – 17,25 điểm; các tiêu chí 5, 11, 12 phải đạt 2,0 điểm.</p>
            <p><strong>c) Loại Trung bình:</strong> 10,00 – 14,25 điểm.</p>
            <p><strong>d) Loại không đạt:</strong> Dưới 10,0 điểm.</p>
            <p class="mt-2"><em><strong>Lưu ý:</strong> Trường hợp tổng điểm đạt loại Giỏi nhưng bị khống chế các tiêu chí thì xếp loại Khá; Tổng điểm đạt loại Khá nhưng bị khống chế các tiêu chí thì được xếp loại Trung bình.</em></p>
          </div>
           <div class="mt-6 sm:max-w-xs">
              <label for="finalRating-eval" class="block text-sm font-medium text-gray-700">Xếp loại tiết dạy</label>
              <div class="mt-1">
                <select id="finalRating-eval" formControlName="finalRating" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                  <option value="" disabled>Chọn xếp loại</option>
                  <option value="Giỏi">Loại Giỏi</option>
                  <option value="Khá">Loại Khá</option>
                  <option value="Trung bình">Loại Trung bình</option>
                  <option value="Không đạt">Loại Không đạt</option>
                </select>
              </div>
           </div>
        </div>
      }
    </div>

     <!-- Section: Evaluation -->
    <div class="rounded-lg bg-white shadow-sm overflow-hidden border">
       <button type="button" (click)="toggleSection('evaluation')" class="w-full flex justify-between items-center p-3 text-left bg-gradient-to-r from-teal-50 via-sky-50 to-indigo-50 hover:from-teal-100 transition-colors focus:outline-none">
        <h3 class="text-sm font-bold uppercase tracking-wider text-teal-800">III. ĐÁNH GIÁ CHUNG</h3>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform transition-transform duration-300 text-teal-600" [class.rotate-180]="!sections().evaluation" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
      </button>
      @if (sections().evaluation) {
        <div class="p-6 border-t animate-fade-in-down space-y-4">
          <div><label for="advantages-eval" class="block text-sm font-medium text-gray-700">1. Ưu điểm</label><div class="mt-1"><textarea id="advantages-eval" formControlName="advantages" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" rows="4"></textarea></div></div>
          <div><label for="disadvantages-eval" class="block text-sm font-medium text-gray-700">2. Khuyết điểm</label><div class="mt-1"><textarea id="disadvantages-eval" formControlName="disadvantages" class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" rows="4"></textarea></div></div>
        </div>
      }
    </div>
    
    <!-- Section: Signatures -->
    <div class="rounded-lg bg-white shadow-sm overflow-hidden border">
       <button type="button" (click)="toggleSection('signatures')" class="w-full flex justify-between items-center p-3 text-left bg-gradient-to-r from-teal-50 via-sky-50 to-indigo-50 hover:from-teal-100 transition-colors focus:outline-none">
        <h3 class="text-sm font-bold uppercase tracking-wider text-teal-800">Ký tên</h3>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform transition-transform duration-300 text-teal-600" [class.rotate-180]="!sections().signatures" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
      </button>
      @if (sections().signatures) {
        <div class="p-6 border-t animate-fade-in-down grid grid-cols-1 sm:grid-cols-3 gap-6 text-center">
            <div>
              <h4 class="font-bold">Giáo viên dạy</h4><p class="text-xs italic mb-2">(chữ ký, họ tên)</p>
              <app-signature-input formControlName="teacherSignature"></app-signature-input>
            </div>
             <div>
              <h4 class="font-bold">Hiệu trưởng/Tổ CM</h4><p class="text-xs italic mb-2">(ký tên và đóng dấu)</p>
              <app-signature-input formControlName="headSignature"></app-signature-input>
            </div>
            <div>
              <h4 class="font-bold">Người dự giờ</h4><p class="text-xs italic mb-2">(chữ ký, họ tên)</p>
              <app-signature-input formControlName="observerSignature"></app-signature-input>
            </div>
        </div>
      }
    </div>

    <div class="flex items-center justify-end pt-4">
      <button type="submit" class="rounded-md bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">Lưu thay đổi</button>
    </div>
  </form>
</div>